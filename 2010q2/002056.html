<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [hatari-devel] Slow sound buffer
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/hatari-devel/2010q2/index.html" >
   <LINK REL="made" HREF="mailto:hatari-devel%40lists.berlios.de?Subject=Re%3A%20%5Bhatari-devel%5D%20Slow%20sound%20buffer&In-Reply-To=%3Calpine.LMD.2.00.1005112300370.24084%40pulsar.staff.proxad.net%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="002055.html">
   <LINK REL="Next"  HREF="002057.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[hatari-devel] Slow sound buffer</H1>
    <B>npomarede at corp.free.fr</B> 
    <A HREF="mailto:hatari-devel%40lists.berlios.de?Subject=Re%3A%20%5Bhatari-devel%5D%20Slow%20sound%20buffer&In-Reply-To=%3Calpine.LMD.2.00.1005112300370.24084%40pulsar.staff.proxad.net%3E"
       TITLE="[hatari-devel] Slow sound buffer">npomarede at corp.free.fr
       </A><BR>
    <I>Tue May 11 23:21:52 CEST 2010</I>
    <P><UL>
        <LI>Previous message: <A HREF="002055.html">[hatari-devel] Slow sound buffer
</A></li>
        <LI>Next message: <A HREF="002057.html">[hatari-devel] Slow sound buffer
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2056">[ date ]</a>
              <a href="thread.html#2056">[ thread ]</a>
              <a href="subject.html#2056">[ subject ]</a>
              <a href="author.html#2056">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Tue, 11 May 2010, David Savinkoff wrote:

&gt;<i> Assuming we try different values instead of 46 ms at 11 kHz, could you try
</I>&gt;<i> these values for &quot;samples&quot; and see if you have better results.
</I>&gt;<i> 
</I>&gt;<i> 20 ms : samples = 221
</I>&gt;<i> 10 ms : samples = 111
</I>
Hello,

were you able to try those shorter values to see if they make things 
better ?

&gt;<i> 
</I>&gt;<i> Hi,
</I>&gt;<i> 
</I>&gt;<i> I'm looking at the Audio_CallBack(), line 33, in audio.c as I say what
</I>&gt;<i> is on my mind here.
</I>&gt;<i> 
</I>&gt;<i> When nGeneratedSamples &gt;= len, enough samples are available, so pass
</I>&gt;<i> completed buffer to audio system. However, what happens if Hatari
</I>&gt;<i> continues to provide more samples than the callback swallows?
</I>&gt;<i> I believe we have to slow down Hatari's sample rate to let the callback
</I>&gt;<i> catch up. The opposite is true when too few samples are generated.
</I>&gt;<i> Otherwise the buffer drifts to the extreme of Not enough samples
</I>&gt;<i> available, or too many (which can cause a delay and lost samples).
</I>&gt;<i> Thus, three sample rates (slower, exact, faster) are needed for each
</I>&gt;<i> of which hatari already has (eg. 44090 44100 44110 Hz) while SDL only
</I>&gt;<i> sees the exact frequency.
</I>&gt;<i> 
</I>&gt;<i> When nGeneratedSamples &gt; len&#160; ; go slower
</I>&gt;<i> When nGeneratedSamples &lt; len&#160; ; go faster
</I>&gt;<i> When nGeneratedSamples == len ; otherwise be exact
</I>&gt;<i> 
</I>&gt;<i> Note that the exact frequency is needed to reduce 'hunting' or
</I>&gt;<i> excessive correcting.
</I>&gt;<i> 
</I>&gt;<i> Maybe this problem will have to be corrected after the release.
</I>
Theorically, I agree that if the system is not able to play sound at the 
same rate they're generated by the emulator then we'll get a delay (or not 
enough sample to play).
But if Hatari generates samples at 44.1 kHz and SDL audio is set to 44.1 
kHz, there should not be noticeable delay. I think alsa/sdl is precise 
enough to have the callback function called at the requested rate.

If such a drift occurs (I agree it can happen), changing freq could be a 
bad idea though ; maybe it wouldn't be heard when playing samples, but for 
ym sound using envelopes or sid effect, I think this could alter the sound 
and be noticeable as those &quot;raw&quot; sound can sometimes combine complex 
sin/square waveforms.

This problem is not unique to hatari, video player can run in the same 
troubles. In that case, I think the policy is to drop some bytes in the 
buffer to be played or to insert silence in this buffer to get as many 
samples as needed by the callback function (this could be interesting to 
have a look at mplayer's source code on this point)

In the case of alsa, I have the feeling that the callback rate is adapted 
to get an exact 44.1 kHz frequency by asking for more or less bytes each 
time (if I recall correctly the value of &quot;len&quot; changes in Audio_CallBack 
if you printf it)

But then, in my daily use, I never experienced such audio synching 
problem, whether with hatari or mplayer for example. For recent computer, 
playing sound at a fixed rate should not be a problem, if errors are 
hearable, I think a part of this could be due to the driver / hardware for 
the sound card.


&gt;<i> 
</I>&gt;<i> I am able to compile SDL-1.2.13 with my gcc toolchain but not SDL-1.2.14
</I>&gt;<i> I'm stuck with SDL-1.2.13
</I>
Do you have the possibility to use a recent live cd (ubuntu, whatever you 
like, ...) and try the binary of Hatari you compiled earlier on your 
system ? It could be interesting to see if the problem remains with a 
recent linux distrib, this could be an alternative to building sdl 1.2.14


Nicolas
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="002055.html">[hatari-devel] Slow sound buffer
</A></li>
	<LI>Next message: <A HREF="002057.html">[hatari-devel] Slow sound buffer
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2056">[ date ]</a>
              <a href="thread.html#2056">[ thread ]</a>
              <a href="subject.html#2056">[ subject ]</a>
              <a href="author.html#2056">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/hatari-devel">More information about the hatari-devel
mailing list</a><br>
</body></html>
