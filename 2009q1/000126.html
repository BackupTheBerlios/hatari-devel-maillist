<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [hatari-devel] Ym / Dma mixing
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/hatari-devel/2009q1/index.html" >
   <LINK REL="made" HREF="mailto:hatari-devel%40lists.berlios.de?Subject=Re%3A%20%5Bhatari-devel%5D%20Ym%20/%20Dma%20mixing&In-Reply-To=%3C498D7F6B.9020807%40freemind-tobe.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000143.html">
   <LINK REL="Next"  HREF="000128.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[hatari-devel] Ym / Dma mixing</H1>
    <B>Jean-Baptiste Berlioz</B> 
    <A HREF="mailto:hatari-devel%40lists.berlios.de?Subject=Re%3A%20%5Bhatari-devel%5D%20Ym%20/%20Dma%20mixing&In-Reply-To=%3C498D7F6B.9020807%40freemind-tobe.com%3E"
       TITLE="[hatari-devel] Ym / Dma mixing">jb.berlioz at freemind-tobe.com
       </A><BR>
    <I>Sat Feb  7 13:32:43 CET 2009</I>
    <P><UL>
        <LI>Previous message: <A HREF="000143.html">[hatari-devel] Ym / Dma mixing
</A></li>
        <LI>Next message: <A HREF="000128.html">[hatari-devel] Ym / Dma mixing
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#126">[ date ]</a>
              <a href="thread.html#126">[ thread ]</a>
              <a href="subject.html#126">[ subject ]</a>
              <a href="author.html#126">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hello,

&gt;&gt;&gt;&gt;<i> + No more desync between SDL buffer and mixing buffer (no more
</I>&gt;&gt;&gt;&gt;<i> mixing buffer btw)
</I>&gt;<i> 
</I>&gt;<i> What do you mean by that? Was there a problem?
</I>&gt;<i> 
</I>
Yes, the old SDL audio callback was dealing with the case.
If there was not enough samples in the buffer, then it was trying to 
compensate with different methods, see below.

 &gt;&gt;&gt;&gt; - Now, when a ym register is written, the affected sample number
 &gt;&gt;&gt;&gt; is computed and the change is stored in a list.
 &gt;&gt;&gt;&gt; When the SDL audio callback needs samples, it calls the ym
 &gt;&gt;&gt;&gt; emulation, and the ym emulation replay the history and generate
 &gt;&gt;&gt;&gt; the samples.
 &gt;
 &gt; So where's the advantage to the old way of generating the samples
 &gt; directly?

The old method was generating samples when a register was changed. So 
between two registers change, no samples where generated. The workaround 
was to generate samples at each VBL, but the ST VBL and the SDL callback 
are not synchronized (and can't be afaik).

The new method can generate samples from the last register set.

&gt;&gt;&gt;&gt;<i> + The SDL audio buffer size is frequency dependant (and small).
</I>&gt;<i> 
</I>&gt;<i> I don't think that this is a good idea to use sizes smaller than 512...
</I>&gt;<i> according to the SDL documentation:
</I>&gt;<i> 
</I>&gt;<i> &quot; desired-&gt;samples : The desired size of the audio buffer in samples.
</I>&gt;<i> This number should be a power of two, and may be adjusted by the audio
</I>&gt;<i> driver to a value more suitable for the hardware. Good values seem to
</I>&gt;<i> range between 512 and 8192 inclusive, depending on the application and
</I>&gt;<i> CPU speed. Smaller values yield faster response time, but can lead to
</I>&gt;<i> underflow if the application is doing heavy processing and cannot fill
</I>&gt;<i> the audio buffer in time. &quot;
</I>
Ok, But it should be kept as small as possible, or the sound will be 
late, i'll change it to 512.
Also note that if you set the same buffer size for all frequencies, the 
sound will be more or less late depending on the output frequency.

&gt;&gt;&gt;&gt;<i> + Added some 4 pole filters (configurable).
</I>&gt;<i> 
</I>&gt;<i> What are they good for? There is hardly any comment in your patch about
</I>&gt;<i> them.
</I>
The code can handle low-pass and high-pass filters.

The Dma sounds generated by the STE are sent to the LMC via a 4 pole filter.

Also, when resampling audio, it's good to remove wrong frequencies 
introduced by the proccess with a low-pass filter. (when downsampling 
it's might be good to remove frequencies that can't be handled by the 
new samplerate before resampling).

&gt;&gt;&gt;&gt;<i> - The Dma sound generation is done the same way. The SDL audio
</I>&gt;&gt;&gt;&gt;<i> callback ask some samples to the Dma emulation (but there's no
</I>&gt;&gt;&gt;&gt;<i> history).
</I>&gt;<i> 
</I>&gt;<i> But what happens when the ST memory has changed inbetween? You might
</I>&gt;<i> copy wrong that in that case?!
</I>
The SDL callback takes a snapshot of the ST memory. So yes,if the 
samples where changed while the buffer was played, then the changes will 
be taken in account at the next SDL audio callback.

It can be handled by an history too.

&gt;&gt;&gt;&gt;<i> PS: about 'improve the dma resampling', maybe *optionally* with a
</I>&gt;&gt;&gt;&gt;<i> configure flag we could use libsamplerate ?
</I>&gt;<i> Some Falcon games / demos that run with 50 kHz DMA sound have really,
</I>&gt;<i> really bad sound quality. I guess this is due to the downsampling to
</I>&gt;<i> 44.1 kHz. So a proper sample rate convertion function could be helpful
</I>&gt;<i> here. So I really would not mind to add an additional autoconf test for
</I>&gt;<i> this.
</I>
Resampling from sample rate N to sample rate other then (int*N) always 
introduce wrong frequencies.
libsamplerate provide either fast or accurate methods, so it can be used 
on all computers by selecting the right method. If the library is not 
available, then i can code a fast linear interpolation.

Thanks for the feedback,
JB

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000143.html">[hatari-devel] Ym / Dma mixing
</A></li>
	<LI>Next message: <A HREF="000128.html">[hatari-devel] Ym / Dma mixing
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#126">[ date ]</a>
              <a href="thread.html#126">[ thread ]</a>
              <a href="subject.html#126">[ subject ]</a>
              <a href="author.html#126">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/hatari-devel">More information about the hatari-devel
mailing list</a><br>
</body></html>
